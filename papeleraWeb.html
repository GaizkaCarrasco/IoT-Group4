<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Papelera Inteligente</title>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SQLite -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ================= ICONOS ================= */
const Icons = {
    Trash2: () => <span>üóëÔ∏è</span>,
    Users: () => <span>üë•</span>,
    TrendingUp: () => <span>üìà</span>,
    Database: () => <span>üóÑÔ∏è</span>,
    Play: () => <span>‚ñ∂Ô∏è</span>,
    Refresh: () => <span>üîÑ</span>,
    Error: () => <span>‚ùå</span>
};

/* ================= APP ================= */
const SmartBinDashboard = () => {
    const [usuarios, setUsuarios] = useState([]);
    const [depositos, setDepositos] = useState([]);
    const [estadisticas, setEstadisticas] = useState([]);
    const [binLevel, setBinLevel] = useState(0);
    const [puntosReciclaje, setPuntosReciclaje] = useState([]);
    const [puntoCercano, setPuntoCercano] = useState(null);
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(false);
    const [apiUrl, setApiUrl] = useState('http://localhost:5000');

    const addLog = msg => {
        const time = new Date().toLocaleString('es-ES');
        setLogs(prev => [...prev, `[${time}] ${msg}`]);
    };

    /* ============ CARGAR DESDE API ============ */
    const loadFromAPI = async () => {
        setLoading(true);
        addLog("Conectando con API...");

        try {
            // Cargar resumen completo
            const resumenRes = await fetch(`${apiUrl}/api/resumen`);
            if (!resumenRes.ok) throw new Error("Error al conectar con la API");
            const resumen = await resumenRes.json();
            
            setBinLevel(resumen.nivel_actual || 0);
            setPuntoCercano(resumen.punto_reciclaje_cercano);
            addLog("‚úì Resumen cargado");

            // Cargar usuarios
            const usuariosRes = await fetch(`${apiUrl}/api/usuarios`);
            const usuariosData = await usuariosRes.json();
            setUsuarios(usuariosData.usuarios || []);
            addLog(`‚úì ${usuariosData.usuarios?.length || 0} usuarios cargados`);

            // Cargar depositos
            const depositosRes = await fetch(`${apiUrl}/api/depositos?limit=50`);
            const depositosData = await depositosRes.json();
            setDepositos(depositosData.depositos || []);
            addLog(`‚úì ${depositosData.depositos?.length || 0} dep√≥sitos cargados`);

            // Cargar estadisticas
            const statsRes = await fetch(`${apiUrl}/api/estadisticas`);
            const statsData = await statsRes.json();
            setEstadisticas(statsData.estadisticas || []);
            addLog("‚úì Estad√≠sticas cargadas");

            // Cargar puntos de reciclaje
            const puntosRes = await fetch(`${apiUrl}/api/puntos-reciclaje?limit=5`);
            const puntosData = await puntosRes.json();
            setPuntosReciclaje(puntosData.puntos || []);
            addLog(`‚úì ${puntosData.puntos?.length || 0} puntos de reciclaje cargados`);

            addLog("‚úì Datos cargados correctamente desde la API");

        } catch (e) {
            console.error(e);
            addLog(`‚ùå Error al cargar desde API: ${e.message}`);
            addLog("‚ö† Verifica que el servidor API est√© ejecut√°ndose en " + apiUrl);
        } finally {
            setLoading(false);
        }
    };

    /* ============ CARGAR BD LOCAL (FALLBACK) ============ */
    const loadDatabaseFromFile = async (file) => {
        setLoading(true);
        addLog("Cargando base de datos local...");

        try {
            const buffer = await file.arrayBuffer();
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });

            const db = new SQL.Database(new Uint8Array(buffer));
            processDatabase(db);
            addLog("‚úì Base de datos importada correctamente");

        } catch (e) {
            console.error(e);
            addLog("‚ùå Error al cargar la base de datos");
        } finally {
            setLoading(false);
        }
    };

    /* ============ PROCESAR BD LOCAL ============ */
    const processDatabase = (db) => {
        /* ---- USUARIOS ---- */
        try {
            const res = db.exec("SELECT * FROM usuarios");
            const users = res[0].values.map(r => ({
                uid: r[0],
                nombre: r[1],
                fecha_registro: r[2]
            }));
            setUsuarios(users);
            addLog(`‚úì ${users.length} usuarios cargados`);
        } catch {
            addLog("‚ö† Tabla usuarios no encontrada");
        }

        /* ---- DEPOSITOS ---- */
        try {
            const res = db.exec("SELECT * FROM depositos");
            const deps = res[0].values.map(r => ({
                id: r[0],
                uid: r[1],
                porcentaje: r[2],
                kg: r[3],
                nivel: r[4],
                fecha: r[5]
            }));
            setDepositos(deps);
            addLog(`‚úì ${deps.length} dep√≥sitos cargados`);

            if (deps.length > 0) {
                setBinLevel(deps[deps.length - 1].nivel);
            }
        } catch {
            addLog("‚ö† Tabla depositos no encontrada");
        }

        /* ---- ESTADISTICAS ---- */
        try {
            const res = db.exec("SELECT * FROM estadisticas");
            const stats = res[0].values.map(r => ({
                uid: r[0],
                depositos: r[1],
                kg: r[2],
                fecha: r[3]
            }));
            setEstadisticas(stats);
            addLog("‚úì Estad√≠sticas cargadas");
        } catch {
            addLog("‚ö† Tabla estadisticas no encontrada");
        }
    };

    const openFile = () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".db,.sqlite,.sqlite3";
        input.onchange = e => loadDatabaseFromFile(e.target.files[0]);
        input.click();
    };

    /* ============ CARGAR AL INICIAR ============ */
    useEffect(() => {
        loadFromAPI();
    }, [apiUrl]);

    /* ============ TOTALES ============ */
    const totalKg = estadisticas.reduce((s, e) => s + (e.kg_total || 0), 0);
    const totalDepositos = estadisticas.reduce((s, e) => s + (e.total_depositos || 0), 0);

    return (
        <div className="min-h-screen bg-gray-100 p-6">
            <h1 className="text-3xl font-bold mb-4">‚ôªÔ∏è Papelera Inteligente</h1>

            <div className="mb-4 flex gap-2 flex-wrap">
                <button
                    onClick={loadFromAPI}
                    disabled={loading}
                    className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50"
                >
                    {loading ? "Cargando..." : "üîÑ Actualizar desde API"}
                </button>
                <button
                    onClick={openFile}
                    disabled={loading}
                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
                >
                    üìÅ Cargar BD Local
                </button>
                <input
                    type="text"
                    value={apiUrl}
                    onChange={e => setApiUrl(e.target.value)}
                    placeholder="URL de la API"
                    className="border px-3 py-2 rounded"
                    style={{minWidth: '200px'}}
                />
            </div>

            {/* LOG */}
            <div className="bg-black text-green-400 p-3 rounded mb-4 text-sm max-h-40 overflow-y-auto">
                {logs.map((l, i) => <div key={i}>{l}</div>)}
            </div>

            {/* RESUMEN */}
            <div className="grid grid-cols-4 gap-4 mb-6">
                <div className="bg-white p-4 rounded shadow">Nivel: <b>{binLevel}%</b></div>
                <div className="bg-white p-4 rounded shadow">Usuarios: <b>{usuarios.length}</b></div>
                <div className="bg-white p-4 rounded shadow">Dep√≥sitos: <b>{totalDepositos}</b></div>
                <div className="bg-white p-4 rounded shadow">Kg: <b>{totalKg.toFixed(2)}</b></div>
            </div>

            {/* USUARIOS */}
            <div className="bg-white p-4 rounded shadow mb-6">
                <h2 className="font-bold mb-2">Usuarios</h2>
                <table className="w-full text-sm">
                    <thead>
                        <tr><th>UID</th><th>Nombre</th></tr>
                    </thead>
                    <tbody>
                        {usuarios.map(u => (
                            <tr key={u.uid}>
                                <td>{u.uid}</td>
                                <td>{u.nombre}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* DEPOSITOS */}
            <div className="bg-white p-4 rounded shadow mb-6">
                <h2 className="font-bold mb-2">√öltimos dep√≥sitos</h2>
                <table className="w-full text-sm">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Kg</th>
                            <th>Nivel</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {depositos.slice(0, 10).map(d => (
                            <tr key={d.id}>
                                <td>{d.nombre || d.uid}</td>
                                <td>{d.kg?.toFixed(2) || d.kg}</td>
                                <td>{d.nivel}%</td>
                                <td>{new Date(d.fecha).toLocaleString('es-ES')}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* PUNTO DE RECICLAJE MAS CERCANO */}
            {puntoCercano && (
                <div className="bg-green-50 border-2 border-green-500 p-4 rounded shadow mb-6">
                    <h2 className="font-bold mb-2 text-green-800">üìç Punto de Reciclaje M√°s Cercano</h2>
                    <div className="text-sm">
                        <p><strong>Nombre:</strong> {puntoCercano.nombre}</p>
                        <p><strong>Direcci√≥n:</strong> {puntoCercano.direccion}</p>
                        <p><strong>Municipio:</strong> {puntoCercano.municipio}</p>
                        <p><strong>Distancia:</strong> {puntoCercano.distancia_km} km</p>
                    </div>
                </div>
            )}

            {/* PUNTOS DE RECICLAJE */}
            {puntosReciclaje.length > 0 && (
                <div className="bg-white p-4 rounded shadow">
                    <h2 className="font-bold mb-2">üó∫Ô∏è Puntos de Reciclaje Cercanos</h2>
                    <table className="w-full text-sm">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Direcci√≥n</th>
                                <th>Distancia</th>
                            </tr>
                        </thead>
                        <tbody>
                            {puntosReciclaje.map((p, i) => (
                                <tr key={i}>
                                    <td>{p.nombre}</td>
                                    <td>{p.direccion}</td>
                                    <td>{p.distancia_km} km</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

ReactDOM.createRoot(document.getElementById("root")).render(<SmartBinDashboard />);
</script>
</body>
</html>
